version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@2.0.0

jobs:
  build-and-test:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}

      - run:
          name: Install Dependencies
          command: npm install

      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}

      # 1. Static Application Security Testing (SAST)
      - run:
          name: SAST - ESLint & Code Vulnerability Check
          command: |
            npx eslint . --ext .js,.jsx --max-warnings 0 || true
            npm audit --audit-level=moderate || true

      # 2. Software Composition Analysis (SCA)
      - run:
          name: SCA - Dependency Security Scan
          command: |
            npm audit --json > audit-report.json || true
            npx audit-ci --moderate || true

      # 3. Run Unit Tests with Coverage
      - run:
          name: Run Tests with Coverage
          command: npm test -- --watchAll=false --coverage

      # 4. SonarCloud Scan (Static Code + Security Hotspots)
      - sonarcloud/scan:
          organization: "michaelamm84"
          projectKey: "Michaelamm84_my-secure-portal"

      # 5. OWASP Dependency Check (Optional)
      - run:
          name: OWASP Dependency Check
          command: |
            wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
            unzip dependency-check-8.4.0-release.zip
            ./dependency-check/bin/dependency-check.sh --scan . --format JSON --out ./reports

      - store_artifacts:
          path: ./reports

      - store_test_results:
          path: ./coverage

  # 6. API Security Testing (Newman/Postman)
  api-security-test:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name: Install Newman (Postman CLI)
          command: npm install -g newman

      - run:
          name: API Security Tests
          command: |
            echo "Running API Security Tests..."
            # Uncomment the next line once Postman collections are ready
            # newman run postman-collection.json -e environment.json || true

# =======================
# Workflows Section
# =======================
workflows:
  version: 2
  build-and-scan:
    triggers:
      - schedule:
          cron: "0 9 * * 1-5"  # Optional: also run every weekday at 9 AM
          filters:
            branches:
              only: main
    jobs:
      - build-and-test:
          context: SonarCloud
      - api-security-test:
          requires:
            - build-and-test
